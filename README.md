# 混沌(Mark)搜索
## v1.0
### 架构
#### 架构组件
* 注册中心
* 搜索结点
* 搜索客户端
#### 注册服务
注册服务分两种情况：
* 一种是原有服务因为各种原因无法服务后又重新加入
* 另一种是新加入的服务
先处理新加入的服务的情况，注册中心将其注册为新的索引服务并分配索引分片id，第二种情况暂时不考虑
## 技术点
### 名词解析
#### 结点中心
本系统的设计可以大致的理解为单中心，多副本的方案。结点泛指索引结点、注册结点、客户端结点以及未来将扩展的结点。
结点中心则是注册结点，这样确定的理由是注册结点将各结点有机连接起来形成了逻辑上的整体，在系统中起到了一个粘合剂和统一调配的作用。
#### 边隅结点
本系统中将索引结点统称为边隅结点，因为这类结点的特征明显，一是提供索引服务，另一个就是它在逻辑上是围绕结点中心的。
### 架构
在前面名词解析中提到，整个系统在逻辑上是中心化的，这意味着如果中心结点意外死亡整个系统都将陷入瘫痪。
这时就需要通过使用集群分布来实现物理上的多中心方案和逻辑上的中心化方案相统一的系统构建方法。
各结点中心采用去中心化结构进行通信，每个结点中心都包含所有的结点中心和所有索引结点的信息
每个边隅结点在首次注册之后获取了所有注册中心的地址，然后随机选取一个注册中心进行注册，当某个注册中心发现注册的边隅结点失去联系就广播给所有注册中心修改边隅结点信息
当边隅结点在心跳注册的过程中发现注册中心死亡则在定期更新的注册中心列表中随机选取一个注册中心进行重新注册并报告注册中心死亡
## 接下来的工作
 1、注册中心做变更推送
 注册中心获得变更后将变更信息广播给所有注册中心和相关结点
 2、注册中心宕机报告机制
 索引服务需要发送心跳包给注册中心，如果索引服务发现注册中心无法连接则认为注册中心宕机、死亡，索引服务将自动把死亡的注册中心报告给其他注册中心，并重新选取一个注册中心进行心跳注册。
 
## 技术问题
> 配置文件的读写

### 日志结构
[Hash] [time] [class Name] [Json Class]

* Hash值采用在此之前3列数据的hash值以16进制字符相加再Hash构成,用于验证日志完整性,当数据列数<=3时，前空闲的用FF补齐
* time表示插入时的时间戳
* class Name 表示索引类型,用于反序列化
* Json Class 经过Json序列化的数据
### 集群分发
各节点之间采用集群分发的方式保持索引的一致性
集群分发采用日志的方式来分发，即分发的内容为一条日志，节点通过记录日志的时间来标识节点所在的位置，通过对日志进行解析来构建索引副本
以此实现索引的轻量化拷贝和无差别拷贝，可以有效降低直接拷贝索引文件而造成的索引延误和数据错位问题。
## 运行
### Jar运行
```shell 
java -Dfile.encoding=UTF-8 -jar MarkSearch-1.0-SNAPSHOT-jar-with-dependencies.jar
```


